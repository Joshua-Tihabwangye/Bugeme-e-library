import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Line, LineChart, ResponsiveContainer, Tooltip, XAxis, YAxis, CartesianGrid, BarChart, Bar, PieChart, Pie, Cell, Legend } from 'recharts';
import { getAdminOverview } from '../../../lib/api/analytics';
import LoadingOverlay from '../../../components/feedback/LoadingOverlay';
import StatCard from '../../../components/cards/StatCard';
const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#f43f5e'];
const periodLabels = {
    today: 'Today',
    week: 'This Week',
    month: 'This Month',
    year: 'This Year'
};
const AdminOverviewPage = () => {
    const [searchPeriod, setSearchPeriod] = useState('month');
    const [likedPeriod, setLikedPeriod] = useState('month');
    const [readsPeriod, setReadsPeriod] = useState('month');
    const [viewedPeriod, setViewedPeriod] = useState('month');
    // Use period for filtering
    const { data, isPending, refetch } = useQuery({
        queryKey: ['admin-overview', readsPeriod, likedPeriod, searchPeriod, viewedPeriod],
        queryFn: () => getAdminOverview(readsPeriod, likedPeriod, searchPeriod, viewedPeriod),
        staleTime: 2 * 60 * 1000,
    });
    if (isPending || !data) {
        return _jsx(LoadingOverlay, { label: "Fetching analytics" });
    }
    const filteredReadsPerDay = data.reads_per_day || [];
    return (_jsxs("div", { className: "space-y-8 animate-in", children: [_jsxs("div", { className: "page-header", children: [_jsx("p", { className: "text-xs font-semibold uppercase tracking-[0.4em] text-brand-600 dark:text-brand-400", children: "Admin" }), _jsx("h1", { className: "page-title", children: "Analytics Overview" }), _jsx("p", { className: "page-subtitle", children: "Monitor library performance and user engagement" })] }), _jsxs("div", { className: "grid gap-6 md:grid-cols-3", children: [_jsx(StatCard, { variant: "blue", label: "Total Books", value: data.overview.total_books, hint: "In library" }), _jsx(StatCard, { variant: "emerald", label: "Active Readers", value: data.overview.total_users, icon: _jsx("svg", { className: "h-6 w-6", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24", children: _jsx("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" }) }), hint: "Registered users" }), _jsxs("div", { className: "relative", children: [_jsxs("div", { className: "card p-4", children: [_jsxs("div", { className: "flex items-center justify-between mb-2", children: [_jsx("p", { className: "text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide", children: "Total Reads" }), _jsx("span", { className: "rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-bold text-slate-600 dark:bg-slate-800 dark:text-slate-400", children: periodLabels[readsPeriod] })] }), _jsx("p", { className: "text-3xl font-bold text-violet-600 dark:text-violet-400", children: data.overview.total_reads_period || data.overview.total_reads }), _jsxs("p", { className: "text-xs text-slate-500 dark:text-slate-400 mt-1", children: ["Book opens (", periodLabels[readsPeriod], ")"] })] }), _jsxs("div", { className: "absolute top-2 right-12 group", children: [_jsx("svg", { className: "h-4 w-4 text-slate-400 cursor-help", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24", children: _jsx("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" }) }), _jsx("div", { className: "absolute right-0 top-6 z-10 hidden group-hover:block w-48 p-2 rounded-lg bg-slate-900 text-white text-xs shadow-lg", children: "Each time a user opens a book to read it, it counts as 1 read." })] })] })] }), _jsxs("div", { className: "grid gap-6 md:grid-cols-2", children: [_jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-6 flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Reading Activity" }), _jsx("p", { className: "text-sm text-slate-600 dark:text-slate-400", children: readsPeriod === 'today' ? 'Hourly reads today' : `Daily reads over the last ${readsPeriod}` })] }), _jsxs("select", { value: readsPeriod, onChange: (e) => setReadsPeriod(e.target.value), className: "rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 dark:border-white/10 dark:bg-slate-800 dark:text-white", children: [_jsx("option", { value: "today", children: "Today" }), _jsx("option", { value: "week", children: "This Week" }), _jsx("option", { value: "month", children: "This Month" }), _jsx("option", { value: "year", children: "This Year" })] })] }), _jsx("div", { className: "h-64", children: _jsx(ResponsiveContainer, { width: "100%", height: "100%", children: _jsxs(LineChart, { data: filteredReadsPerDay, children: [_jsx("defs", { children: _jsxs("linearGradient", { id: "colorReads", x1: "0", y1: "0", x2: "0", y2: "1", children: [_jsx("stop", { offset: "5%", stopColor: "#3b82f6", stopOpacity: 0.3 }), _jsx("stop", { offset: "95%", stopColor: "#3b82f6", stopOpacity: 0 })] }) }), _jsx(CartesianGrid, { strokeDasharray: "3 3", stroke: "#e2e8f0", opacity: 0.5 }), _jsx(XAxis, { dataKey: "date", hide: true, stroke: "#64748b" }), _jsx(YAxis, { stroke: "#64748b", allowDecimals: false, tick: { fill: '#64748b', fontSize: 12 } }), _jsx(Tooltip, { contentStyle: {
                                                    background: 'white',
                                                    border: '1px solid #e2e8f0',
                                                    borderRadius: '12px',
                                                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                                }, labelStyle: { color: '#1e293b', fontWeight: 600 } }), _jsx(Line, { type: "monotone", dataKey: "count", stroke: "#3b82f6", strokeWidth: 3, dot: { fill: '#3b82f6', r: 4 }, activeDot: { r: 6 }, fill: "url(#colorReads)" })] }) }) })] }), _jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-6 flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Popular Categories" }), _jsx("p", { className: "text-sm text-slate-600 dark:text-slate-400", children: "Most liked book categories" })] }), _jsxs("select", { value: likedPeriod, onChange: (e) => setLikedPeriod(e.target.value), className: "rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 dark:border-white/10 dark:bg-slate-800 dark:text-white", children: [_jsx("option", { value: "today", children: "Today" }), _jsx("option", { value: "week", children: "This Week" }), _jsx("option", { value: "month", children: "This Month" })] })] }), _jsx("div", { className: "h-64", children: _jsx(ResponsiveContainer, { width: "100%", height: "100%", children: _jsxs(PieChart, { children: [_jsx(Pie, { data: data.most_liked_categories, cx: "50%", cy: "50%", innerRadius: 60, outerRadius: 90, paddingAngle: 5, dataKey: "likes", nameKey: "name", label: ({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`, labelLine: { stroke: '#64748b' }, children: data.most_liked_categories.map((entry, index) => (_jsx(Cell, { fill: COLORS[index % COLORS.length] }, `cell-${index}`))) }), _jsx(Tooltip, { contentStyle: {
                                                    background: 'white',
                                                    border: '1px solid #e2e8f0',
                                                    borderRadius: '12px',
                                                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                                } }), _jsx(Legend, { wrapperStyle: { fontSize: '12px' }, iconType: "circle" })] }) }) })] })] }), _jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-6", children: [_jsx("h2", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Peak Usage Times" }), _jsx("p", { className: "text-sm text-slate-600 dark:text-slate-400", children: "Book opens by hour of day (shows when users are most active)" })] }), _jsx("div", { className: "h-64", children: _jsx(ResponsiveContainer, { width: "100%", height: "100%", children: _jsxs(BarChart, { data: data.reads_per_hour, children: [_jsx("defs", { children: _jsxs("linearGradient", { id: "colorBar", x1: "0", y1: "0", x2: "0", y2: "1", children: [_jsx("stop", { offset: "0%", stopColor: "#f59e0b", stopOpacity: 1 }), _jsx("stop", { offset: "100%", stopColor: "#f59e0b", stopOpacity: 0.7 })] }) }), _jsx(CartesianGrid, { strokeDasharray: "3 3", stroke: "#e2e8f0", opacity: 0.5 }), _jsx(XAxis, { dataKey: "hour", stroke: "#64748b", tick: { fill: '#64748b', fontSize: 12 }, tickFormatter: (hour) => `${hour}:00` }), _jsx(YAxis, { stroke: "#64748b", allowDecimals: false, tick: { fill: '#64748b', fontSize: 12 } }), _jsx(Tooltip, { contentStyle: {
                                            background: 'white',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '12px',
                                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                        }, labelStyle: { color: '#1e293b', fontWeight: 600 }, labelFormatter: (hour) => `${hour}:00 - ${hour + 1}:00`, formatter: (value) => [`${value} opens`, 'Book Opens'] }), _jsx(Bar, { dataKey: "count", fill: "url(#colorBar)", radius: [8, 8, 0, 0] })] }) }) })] }), _jsxs("div", { className: "grid gap-6 md:grid-cols-3", children: [_jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsx("h3", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Most Viewed Books" }), _jsxs("select", { value: viewedPeriod, onChange: (e) => setViewedPeriod(e.target.value), className: "rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs font-medium text-slate-700 dark:border-white/10 dark:bg-slate-800 dark:text-white", children: [_jsx("option", { value: "today", children: "Today" }), _jsx("option", { value: "week", children: "This Week" }), _jsx("option", { value: "month", children: "This Month" })] })] }), _jsx("ul", { className: "space-y-3", children: data.most_read_books?.slice(0, 6).map((book, index) => (_jsxs("li", { className: "flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 p-3 transition-colors hover:bg-slate-100 dark:border-white/5 dark:bg-slate-800/50 dark:hover:bg-slate-800", children: [_jsxs("div", { className: "flex items-center gap-3", children: [_jsx("div", { className: "flex h-7 w-7 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-xs font-bold text-white", children: index + 1 }), _jsxs("div", { className: "min-w-0", children: [_jsx("p", { className: "text-sm font-semibold text-slate-900 dark:text-white truncate", children: book.title }), _jsx("p", { className: "text-xs text-slate-600 dark:text-slate-400", children: book.author })] })] }), _jsxs("span", { className: "rounded-full bg-blue-100 px-2 py-1 text-xs font-semibold text-blue-700 dark:bg-blue-500/20 dark:text-blue-300 shrink-0", children: [book.view_count, " views"] })] }, book.id))) })] }), _jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsx("h3", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Most Liked Books" }), _jsxs("select", { value: likedPeriod, onChange: (e) => setLikedPeriod(e.target.value), className: "rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs font-medium text-slate-700 dark:border-white/10 dark:bg-slate-800 dark:text-white", children: [_jsx("option", { value: "today", children: "Today" }), _jsx("option", { value: "week", children: "This Week" }), _jsx("option", { value: "month", children: "This Month" })] })] }), _jsx("ul", { className: "space-y-3", children: (data.most_liked_books?.length > 0 ? data.most_liked_books : []).slice(0, 6).map((book, index) => (_jsxs("li", { className: "flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 p-3 transition-colors hover:bg-slate-100 dark:border-white/5 dark:bg-slate-800/50 dark:hover:bg-slate-800", children: [_jsxs("div", { className: "flex items-center gap-3", children: [_jsx("div", { className: "flex h-7 w-7 items-center justify-center rounded-full bg-gradient-to-br from-rose-500 to-pink-600 text-xs font-bold text-white", children: index + 1 }), _jsxs("div", { className: "min-w-0", children: [_jsx("p", { className: "text-sm font-semibold text-slate-900 dark:text-white truncate", children: book.title }), _jsx("p", { className: "text-xs text-slate-600 dark:text-slate-400", children: book.author })] })] }), _jsxs("span", { className: "rounded-full bg-rose-100 px-2 py-1 text-xs font-semibold text-rose-700 dark:bg-rose-500/20 dark:text-rose-300 shrink-0", children: [book.like_count || 0, " likes"] })] }, book.id))) })] }), _jsxs("div", { className: "card", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsx("h3", { className: "text-xl font-bold text-slate-900 dark:text-white", children: "Top Search Terms" }), _jsxs("select", { value: searchPeriod, onChange: (e) => setSearchPeriod(e.target.value), className: "rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs font-medium text-slate-700 dark:border-white/10 dark:bg-slate-800 dark:text-white", children: [_jsx("option", { value: "today", children: "Today" }), _jsx("option", { value: "week", children: "This Week" }), _jsx("option", { value: "month", children: "This Month" })] })] }), _jsx("ul", { className: "space-y-3", children: data.top_search_terms?.slice(0, 6).map((term, index) => (_jsxs("li", { className: "flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 p-3 transition-colors hover:bg-slate-100 dark:border-white/5 dark:bg-slate-800/50 dark:hover:bg-slate-800", children: [_jsxs("div", { className: "flex items-center gap-3", children: [_jsx("div", { className: "flex h-7 w-7 items-center justify-center rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 text-xs font-bold text-white", children: index + 1 }), _jsxs("span", { className: "text-sm font-medium text-slate-900 dark:text-white", children: ["#", term.term] })] }), _jsxs("span", { className: "rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300 shrink-0", children: [term.count, " searches"] })] }, term.term))) })] })] })] }));
};
export default AdminOverviewPage;
