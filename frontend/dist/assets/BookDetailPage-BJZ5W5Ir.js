import{a as w,u as _,j as e,L as B}from"./index-C_R6iRdk.js";import{u as L}from"./useQuery-DjejrF76.js";import{u as c}from"./useMutation-Com-Be19.js";import{h as Q,e as S,r as k}from"./react-vendor-BXWpoY3z.js";import{t as D,b as P,c as q}from"./catalog-Bppt2uaP.js";import{S as C}from"./SubscriptionPaywall-1SMx7_5Z.js";import{u as A}from"./useSubscription-g3_UUASn.js";import"./ui-vendor-DTvEXM4H.js";import"./subscriptions-D2v3T0Hl.js";const V=()=>{const{bookId:r}=Q(),l=S(),o=w(),u=_(s=>s.user),[x,d]=k.useState(!1),[b,m]=k.useState(""),{needsSubscription:p,isLoading:h}=A(),{data:a,isLoading:g}=L({queryKey:["book",r],queryFn:()=>q(r),enabled:!!r,staleTime:5*60*1e3}),y=c({mutationFn:()=>D(Number(r)),onMutate:async()=>{await o.cancelQueries({queryKey:["book",r]});const s=o.getQueryData(["book",r]);return o.setQueryData(["book",r],t=>t&&{...t,is_liked:!t.is_liked,like_count:t.is_liked?t.like_count-1:t.like_count+1}),{previousBook:s}},onError:(s,t,i)=>{i?.previousBook&&o.setQueryData(["book",r],i.previousBook)},onSettled:()=>o.invalidateQueries({queryKey:["book",r]})}),j=c({mutationFn:()=>P(Number(r)),onMutate:async()=>{await o.cancelQueries({queryKey:["book",r]});const s=o.getQueryData(["book",r]);return o.setQueryData(["book",r],t=>t&&{...t,is_bookmarked:!t.is_bookmarked,bookmark_count:t.is_bookmarked?t.bookmark_count-1:t.bookmark_count+1}),{previousBook:s}},onError:(s,t,i)=>{i?.previousBook&&o.setQueryData(["book",r],i.previousBook)},onSettled:()=>o.invalidateQueries({queryKey:["book",r]})}),n=s=>!h&&p?(m(s==="like"?"like books":s==="bookmark"?"bookmark books":"read books"),d(!0),!0):!1,f=()=>{n("like")||y.mutate()},v=()=>{n("bookmark")||j.mutate()},N=()=>{n("read")||l(`/reader/${a?.id}`)};return g||!a?e.jsx(B,{label:"Loading book details"}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("button",{onClick:()=>l(-1),className:"text-sm text-slate-600 dark:text-slate-400",children:"← Back to list"}),e.jsxs("div",{className:"card grid gap-8 lg:grid-cols-3",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-brand-600 dark:text-brand-300",children:a.author}),e.jsx("h1",{className:"mt-2 text-4xl font-semibold text-slate-900 dark:text-white",children:a.title}),e.jsx("p",{className:"mt-4 text-slate-700 dark:text-slate-300",children:a.description}),e.jsxs("div",{className:"mt-6 grid gap-4 text-sm text-slate-600 dark:text-slate-400 sm:grid-cols-2",children:[e.jsxs("p",{children:["Language: ",a.language]}),e.jsxs("p",{children:["Year: ",a.year??"—"]}),e.jsxs("p",{children:["Pages: ",a.pages??"—"]}),e.jsxs("p",{children:["ISBN: ",a.isbn]})]}),e.jsx("div",{className:"mt-6 flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-500",children:Array.isArray(a.tags)&&a.tags.map(s=>e.jsxs("span",{className:"rounded-full border border-slate-200 px-3 py-1 dark:border-white/10",children:["#",s]},s))})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-800 dark:border-white/10 dark:bg-white/5 dark:text-slate-300",children:[e.jsx("p",{className:"text-xs font-semibold uppercase text-slate-500 dark:text-slate-400",children:"Stats"}),e.jsxs("p",{className:"mt-3",children:["Views • ",a.view_count]}),e.jsxs("p",{children:["Likes • ",a.like_count]}),e.jsxs("p",{children:["Bookmarks • ",a.bookmark_count]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("div",{className:"text-lg leading-none text-yellow-400",children:"★★★★☆"}),e.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:"4.0 rating"})]})]}),u?e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{className:"btn-primary w-full",onClick:N,children:"Open reader"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`w-1/2 rounded-lg border px-3 py-2 text-sm font-semibold transition ${a.is_liked?"border-red-500 bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-400":"border-slate-300 text-slate-700 hover:border-red-500/50 hover:bg-red-50 dark:border-white/10 dark:text-white dark:hover:bg-red-500/5"}`,onClick:f,children:"♥ Like"}),e.jsx("button",{className:`w-1/2 rounded-lg border px-3 py-2 text-sm font-semibold transition ${a.is_bookmarked?"border-brand-500 bg-brand-50 text-brand-700 dark:bg-brand-400/10 dark:text-brand-300":"border-slate-300 text-slate-700 hover:border-brand-400/50 hover:bg-brand-50 dark:border-white/10 dark:text-white dark:hover:bg-brand-400/5"}`,onClick:v,children:"⌁ Bookmark"})]})]}):e.jsx("p",{className:"text-xs text-slate-400",children:"Log in to like, bookmark, and open the reader."})]})]}),e.jsx(C,{isOpen:x,onClose:()=>d(!1),actionBlocked:b})]})};export{V as default};
